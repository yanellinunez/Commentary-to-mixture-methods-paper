---
title: "Group_lasso_wrong_grouping"
author: "Yanelli Nunez"
date: "10/3/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(caret)
library(Hmisc)
library(glmnet)
library(grpreg)
```

# Data Import and Cleaning 

```{r}
study_pop = read_csv("Data/studypop.csv") %>% 
  clean_names(case = c("old_janitor")) %>% 
  mutate(bmi_cat3 = as.factor(bmi_cat3),
         edu_cat = as.factor(edu_cat),
         race_cat = as.factor(race_cat),
         male = as.factor(male)) 

data = study_pop %>% 
  mutate_at(vars(contains("la")), log) %>% 
  mutate(log_telomean = log(telomean)) %>% 
  dplyr::select(log_telomean, lbx074la:lbx187la, lbxd03la:lbx194la, everything(), -seqn, -telomean) %>% 
  na.omit(log_telomean) 

# Create a matrix of predictors as x
x = model.matrix(log_telomean ~ ., data)[,-1]

# Extract outcome vector
y = data$log_telomean
```

#Variable grouping for group lasso

This yields the wrong grouping by assigning pct to the Non-Ortho PCB group. 

```{r}

group3 <- vector()
group3[grepl("pct", colnames(x))] <- "0"
group3[grepl("bcsi", colnames(x))] <- "0"
group3[grepl("bmi", colnames(x))] <- "0"
group3[grepl("edu", colnames(x))] <- "0"
group3[grepl("race", colnames(x))] <- "0"
group3[grepl("male", colnames(x))] <- "0"
group3[grepl("bxcot", colnames(x))] <- "0"
group3[grepl("age", colnames(x))] <- "0"
group3[grepl("lbx1|0",colnames(x))] <- "Non-Dioxin-like PCB"
group3[grepl("lbxd", colnames(x))] <- "TEQ"
group3[grepl("lbxf", colnames(x))] <- "TEQ"
group3[grepl("lbxh|p", colnames(x))] <- "Non-Ortho PCB"
group3[grepl("lbx118la", colnames(x))] <- "TEQ"

group3 <- as.factor(group3)

cbind(colnames(x), group3) #bind by columns
```

The cross validation seems to work when we have the wrong grouping 

```{r}
cv_lasso_3 <- cv.grpreg(x, y, group3, 
                        penalty = "grLasso", seed = 1988)

plot(cv_lasso_3)
```


#Functions
```{r}
fit_with_cv = function(seed) {
  cv_lasso_3 <- cv.grpreg(x, y, group3, 
                          penalty = "grLasso", seed = seed)
  
  #Find the lambda that results in the smallest CV error
  best_lasso_3 <- cv_lasso_3$lambda.min
  
  #Fit model with cross-validated lambda
  fit_lasso_3 <- grpreg(x, y, group3, penalty = "grLasso", lambda = best_lasso_3)
  
  fit_lasso_3
}

extract_coefs_grlasso = function(fit) {
  as_tibble(fit$beta, rownames = "variable") %>% 
    rename(beta = 2) %>% 
    filter(variable != "(Intercept)")  %>% 
    mutate(group3 = group3) %>% 
    filter(group3 %in% c("TEQ", "Non-Dioxin-like PCB", "Non-Ortho PCB"))
}
```

# Looping for different seeds for group lasso
```{r}
repeat_cv_group_lasso = 
  tibble(seed = 1:100) %>% 
  mutate(
    fits = map(seed, ~fit_with_cv(seed = .x)),
    coefs = map(fits, extract_coefs_grlasso)) %>% 
  dplyr::select(-fits) %>% 
  unnest() %>%
  rename(beta_grlasso = "beta")
```
  
#plot  

This plot looks better (when we have the wrong grouping); the coefficients are more consistent when looping the seed
```{r}
betas_grplasso <- repeat_cv_group_lasso %>%
  ggplot() + 
  geom_point(aes(x = seed, y = beta_grlasso), color = 'dark green', size = 0.5, alpha = 0.5) + 
  facet_wrap(~variable)
betas_grplasso
```
  
  
