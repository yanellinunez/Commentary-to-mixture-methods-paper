---
title: "group_lasso_single_groupping"
author: "Yanelli Nunez"
date: "10/14/2019"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
library(viridis)
library(grpreg)
library(janitor)
library(glmnet)

#This turns off scientific notation
options(scipen = 999)

sessionInfo()
```



# Data Import and Cleaning 

First, load the dataset; clean up names as needed; and convert factors to, well, factors. Next we remove missing values and reorder predictors (environmental variables first, confounders second). In keeping with standard practice, we'll ln-transform the environmental exposures and the outcome. This is the dataset we'll use to illustrate variable selection methods.

```{r}
study_pop = read_csv("Data/studypop.csv") %>% 
  clean_names(case = c("old_janitor")) %>% 
  mutate(bmi_cat3 = as.factor(bmi_cat3),
         edu_cat = as.factor(edu_cat),
         race_cat = as.factor(race_cat),
         male = as.factor(male)) 

data = study_pop %>% 
  mutate_at(vars(contains("la")), log) %>% 
  mutate(log_telomean = log(telomean)) %>% 
  dplyr::select(log_telomean, lbx074la:lbx187la, lbxd03la:lbx194la, everything(), -seqn, -telomean) %>% 
  na.omit(log_telomean) 

# Create a matrix of predictors as x
x = model.matrix(log_telomean ~ ., data)[,-1]

# Extract outcome vector
y = data$log_telomean
```


# Group lasso

### Variable grouping for group lasso

```{r}
group3 <- vector()
group3[colnames(x) == "lbx074la"] <- "PCB 174"
group3[colnames(x) == "lbx138la"] <- "PCB 138"
group3[colnames(x) == "lbx118la"] <- "PCB 118"
group3[colnames(x) == "lbx099la"] <- "PCB 99"
group3[colnames(x) == "lbx153la"] <- "PCB 153"
group3[colnames(x) == "lbx170la"] <-  "PCB 170"
group3[colnames(x) == "lbx180la"] <-  "PCB 180"
group3[colnames(x) == "lbx187la"] <- "PCB 187" 
group3[colnames(x) == "lbx194la"] <- "PCB 194"
group3[colnames(x) == "lbxd03la"] <- "1,2,3,6,7,8-hxcdd" 
group3[colnames(x) == "lbxd05la"] <- "1,2,3,4,6,7,8-hpcdd" 
group3[colnames(x) == "lbxd07la"] <- "1,2,3,4,6,7,8,9-ocdd" 
group3[colnames(x) == "lbxf03la"] <- "2,3,4,7,8-pncdf" 
group3[colnames(x) == "lbxf04la"] <- "1,2,3,4,7,8-hxcdf"
group3[colnames(x) == "lbxf05la"] <- "1,2,3,6,7,8-hxcdf"
group3[colnames(x) == "lbxf08la"] <- "1,2,3,4,6,7,8-hxcdf"
group3[colnames(x) == "lbxhxcla"] <- "PCB 169"
group3[colnames(x) == "lbxpcbla"] <- "PCB 126"
group3[grepl("pct", colnames(x))] <- "0"
group3[grepl("bcsi", colnames(x))] <- "0"
group3[grepl("bmi", colnames(x))] <- "0"
group3[grepl("edu", colnames(x))] <- "0"
group3[grepl("race", colnames(x))] <- "0"
group3[grepl("male", colnames(x))] <- "0"
group3[grepl("bxcot", colnames(x))] <- "0"
group3[grepl("age", colnames(x))] <- "0"
group3 <- as.factor(group3)

cbind(colnames(x), group3) #bind by columns

```


### Group Lasso w/ CV

As with `glmnet`, we can use CV to choose the tuning parameters. If not specified in code, ten-fold CV is the default. 

We perform this analysis with the three-group model and the lasso penalty.

```{r cvlasso}
cv_single_lasso_3 <- cv.grpreg(x, y, group3, 
                        penalty = "grLasso", seed = 1988)

#plot(cv_single_lasso_3) This is giving me an error that I do not understand 

cv_single_lasso_3$cve #cross-validation error
cv_single_lasso_3$cvse #std error of CV error
log(cv_single_lasso_3$lambda) # log(lambda)

plot(desc(log(cv_single_lasso_3$lambda)), cv_single_lasso_3$cve)
```


### Loop Over Seeds

```{r}
fit_with_cv = function(seed) {
  cv_lasso_loop <- cv.grpreg(x, y, group3, 
                          penalty = "grLasso", seed = seed)
  
  loop_cve   <- cv_lasso_loop$cve  #cross-validation error
  loop_cvse  <- cv_lasso_loop$cvse #std error of CV error
  loop_lam <- cv_lasso_loop$lambda 
  
  dat <- cbind(lam = loop_lam, cve = loop_cve, cvse = loop_cvse) %>% 
    as_tibble() %>% 
    mutate(upper = cve + 1.96*cvse,
         lower = cve - 1.96*cvse) %>% 
    mutate(seed1 = seed)
}

repeat_cv = 
  tibble(seed = 1:100) %>%
  mutate(
    fits = map(seed, ~fit_with_cv(seed = .x))) %>% 
  unnest() %>% 
  mutate(seed = as.factor(seed))
```


# Data Visualization

### With Error Bars
```{r}
repeat_cv %>% 
  ggplot(aes(x = lam, y = cve, color = seed)) + 
  geom_point() + 
  geom_line() +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  theme(legend.position = "none") +
  labs(x = expression(lambda), y = "Cross-Validation Error")
```

### Without Error Bars
```{r}
repeat_cv %>% 
  ggplot(aes(x = lam, y = cve, color = seed)) + 
  geom_point() + 
  geom_line() +
  theme(legend.position = "none") +
  labs(x = expression(lambda), y = "Cross-Validation Error")
```

### Selected \lambda

```{r}
min_cv <- repeat_cv %>% 
  group_by(seed) %>% 
  filter(cve == min(cve))

min_cv %>% 
  ggplot(aes(y = lam, x = seed)) + 
  geom_point(aes(color = lam)) + 
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, size = 9)) +
  labs(x = "seed", y = expression("Cross-Validation Selected "*lambda))
```

