---
title: "betas for WQS based on seed number"
author: "Yanelli Nunez"
date: "8/16/2019"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth : 4
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
#install.packages("gWQS", dependencies = TRUE)
#devtools::package_deps("gWQS") can use this to see which package dependencies you already have

library(tidyverse)

#install.packages("devtools")
#require(devtools)
#install_version("gWQS", version = "1.1.1", repos = "http://cran.us.r-project.org")

library(gWQS)

options(scipen = 999)
```


Note: R is version: 3.6.1
glmnet and grpreg package are the older versions
```{r}
sessionInfo()
```

## Data Import and Cleaning

```{r import}
# import the dataset
dataset = read_csv(here::here("Data/studypop.csv"))

# define the chemicals to include in the mixture
mixture = c("LBX074LA", "LBX099LA", "LBX118LA", "LBX138LA", "LBX153LA", "LBX170LA", "LBX180LA", "LBX187LA",
            "LBX194LA", "LBXD03LA", "LBXD05LA", "LBXD07LA", "LBXF03LA", "LBXF04LA", "LBXF05LA", "LBXF08LA",
            "LBXHXCLA", "LBXPCBLA")

# log-transform the outcome
dataset$log_TELOMEAN = log(dataset$TELOMEAN)


# redefine variables race_cat and edu_cat as factors
dataset$race_cat = factor(dataset$race_cat, levels = c(1, 2, 3, 4), labels = c(1, 2, 3, 4))
dataset$edu_cat = factor(dataset$edu_cat, levels = c(1, 2, 3, 4), labels = c(1, 2, 3, 4))
dataset$bmi_cat3 = factor(dataset$bmi_cat3, levels = c(1, 2, 3), labels = c(1, 2, 3))
```

## Weighted Quantile Sums
Note:
There is a new version of the gwqs package (version 2.0.0). The input for the function is a bit different compare to version 1.1.1 and the results are different. Here I am using the old package to check the seed issue. 


### Positive Adjusted Model
### For old gWQS version

Here we obtained the same results that we optain in the workshop using the old package with the new version of R
```{r model_2}
# adjust for covariates:
# blood data: LBXWBCSI LBXLYPCT LBXMOPCT LBXEOPCT LBXBAPCT LBXNEPCT
# demographics: age_cent age_sq race_cat bmi_cat3 ln_lbxcot edu_cat


result2 = gwqs(log_TELOMEAN ~ LBXWBCSI + LBXLYPCT + LBXMOPCT + LBXEOPCT + LBXBAPCT + LBXNEPCT + 
               age_cent + age_sq + race_cat + bmi_cat3 + ln_lbxcot + edu_cat + male, 
               mix_name = mixture, data = dataset, q = 10, 
               validation = 0.6, valid_var = NULL, b = 100, b1_pos = TRUE, b1_constr = FALSE, 
               family = "gaussian", 
               seed = 123, wqs2 = FALSE, plots = TRUE, tables = TRUE)

summary(result2$fit)
result2$final_weights %>% knitr::kable()
confint(result2$fit)

```


```{r}

fit_gwqs = function(seed) {
  gwqs = gwqs(log_TELOMEAN ~ LBXWBCSI + LBXLYPCT + LBXMOPCT + LBXEOPCT + LBXBAPCT + LBXNEPCT + 
               age_cent + age_sq + race_cat + bmi_cat3 + ln_lbxcot + edu_cat + male, 
               mix_name = mixture, data = dataset, q = 10, 
               validation = 0.6, valid_var = NULL, b = 100, b1_pos = TRUE, b1_constr = FALSE, 
               family = "gaussian", 
               seed = seed, wqs2 = FALSE, plots = FALSE, tables = FALSE)


weights <- as_tibble(gwqs$final_weights, rownames = "variable") %>% 
    select(-mix_name) 
  weights

}


repeat_gwqs = 
  tibble(seed = 1:50) %>% 
  mutate(
    fits = map(seed, ~fit_gwqs(seed = .x))) %>%
  unnest() 

write_csv(repeat_gwqs, "gWQS_1.1.1_R3.1.6 weights.csv")
```



```{r}
repeat_gwqs %>%
  ggplot() + 
  geom_point(aes(x = seed, y = mean_weight), color = "red", size = 0.5, alpha = 0.5) + 
  facet_wrap(~variable) + 
  geom_hline(yintercept = 0) +
  ggtitle("WQS weights")
```


















### Positive Adjusted Model
### for new gWQS version

```{r model_2}
# adjust for covariates:
# blood data: LBXWBCSI LBXLYPCT LBXMOPCT LBXEOPCT LBXBAPCT LBXNEPCT
# demographics: age_cent age_sq race_cat bmi_cat3 ln_lbxcot edu_cat

# redefine variables race_cat and edu_cat as factors
dataset$race_cat = factor(dataset$race_cat, levels = c(1, 2, 3, 4), labels = c(1, 2, 3, 4))
dataset$edu_cat = factor(dataset$edu_cat, levels = c(1, 2, 3, 4), labels = c(1, 2, 3, 4))
dataset$bmi_cat3 = factor(dataset$bmi_cat3, levels = c(1, 2, 3), labels = c(1, 2, 3))

result2 = gwqs(log_TELOMEAN ~ wqs + LBXWBCSI + LBXLYPCT + LBXMOPCT + LBXEOPCT + LBXBAPCT + LBXNEPCT + 
               age_cent + age_sq + race_cat + bmi_cat3 + ln_lbxcot + edu_cat + male, 
               mix_name = mixture, data = dataset, q = 10, 
               validation = 0.6, b = 100, b1_pos = TRUE, b1_constr = FALSE, 
               family = "gaussian", 
               seed = 123, plots = TRUE, tables = TRUE)


summary(result2$fit)
result2$final_weights %>% knitr::kable()
```




